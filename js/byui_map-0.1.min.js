var categories=[],categoryItems=[],markerCatArray=[],markers=[],markerArray=[],infoWindow,mapBounds=new google.maps.LatLngBounds(new google.maps.LatLng(43.811265,-111.786779),new google.maps.LatLng(43.821521,-111.778185)),objectFile="objectFile.txt",polygonFile="http://www2.byui.edu/Test/parking_data.xml",parkingLayer;
function listCategories(){$.getJSON(objectFile,function(a){categories=a.info.categories;categoryItems=a.dataObjects;$.each(categories,function(a,b){var d=b.name,f=b.title;$('<div class="marker_category"/>').html('<a href="#" class="marker_category_a" name="catIndex_'+a+'" id="category_'+d+'">'+f+'</a><div id="category_div_'+d+'" class="hidden"/>').appendTo("#categories");markerArray[a-0]=[];markerArray[d+"_bounds"]=[]})}).success(function(){console.log("json success")}).error(function(){console.log("json failed")}).complete(function(){console.log("json completed")})}
var myLatlng=new google.maps.LatLng(43.814188,-111.783515),myOptions={maxZoom:18,zoom:17,center:myLatlng,mapTypeId:google.maps.MapTypeId.SATELLITE,mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP,google.maps.MapTypeId.SATELLITE,google.maps.MapTypeId.HYBRID,google.maps.MapTypeId.TERRAIN]}};function initialize(){map=new google.maps.Map(document.getElementById("map_canvas"),myOptions);infoWindow=new google.maps.InfoWindow;listCategories()}
function populateCategories(a,c,b){infoWindow.close();a=a.substring(9);b=b.substring(9);-1==$.inArray(a,markerCatArray)&&("parking"!=a?loadPins(a,c,!1):""!=parkingLayer?(console.log("parkingLayer != ''"),loadPolygonCategory(a,c,!0)):console.log("parkingLayer == ''"));showHideCategory(a,c,b);windowResize()}
function loadPins(a,c,b){if(!1==b){var d="category not found",f="default.png";markerArray.push(perform(a));$.each(categories,function(c,b){b.name==a&&(f=b.icon,d=b.ID-1)});c="div#category_div_"+a;$('<div name="'+categories[d].name+'_cat_description" class="cat_description"/>').html(categories[d].text).appendTo(c);$('<ul class="object_list"/>').appendTo(c);var g=new google.maps.LatLngBounds;$.each(categoryItems[a],function(c,b){var e=b.name,j=b.code;if(b.info)var l=b.info;if(b.img)var m="images/"+
b.img;var n=b.icon?"images/"+b.icon:"images/"+f;if(b.link)var o=b.link;if(b.code)var k=a+"_"+j;var h=new google.maps.Marker({position:new google.maps.LatLng(b.lat,b.lon),map:map,title:e,icon:n});markerArray[a+"_bounds"].push(g);markerCatArray.push(a);markerArray[d].push(h);j="div#category_div_"+a+" ul";$("<li name='"+k+"'/>").html('<img src="'+n+'" alt="'+k+'"/><span>'+e+"</span>").click(function(){displayPoint(h,c)}).appendTo(j);google.maps.event.addListener(h,"click",function(){infoWindow||(infoWindow=
new google.maps.InfoWindow);var a='<div id="'+k+'" class="infopane"><h2>'+e+"</h2><div>";m&&(a+='<img src="'+m+'" alt="'+e+'" width="40%"/>');l&&(a+=l);o&&(a+='<br/><a href="'+o+'">More information about '+e+" on the web</a>");infoWindow.setContent(a+"</div></div>");infoWindow.open(map,h);fitToMarkers(markerArray[d])})});fitToMarkers(markerArray[d])}}
function loadPolygonCategory(a){var c="category not found";markerArray.push(perform(a));$.each(categories,function(b,f){f.name==a&&(c=f.ID-1)});markerCatArray.push(a);var b="div#category_div_"+a;$('<div name="'+categories[c].name+'_cat_description" class="cat_description"/>').html(categories[c].text).appendTo(b);$('<ul class="polygon_list"/>').appendTo(b);$.each(categoryItems[a],function(b,c){var g=c.name,p=c.contains,i=c.borderColor,e=c.fillColor;markerCatArray.push(a);i='<div class="polygon_key" style="border-color:'+
i+";background-color:"+e+'">&nbsp;</div>';e="div#category_div_"+a+" ul";$('<li name="polygon_'+g+'" title="'+p+'"/>').html(i+"<span>"+g+"</span>").appendTo(e)});parkingLayer=new google.maps.KmlLayer(polygonFile);console.log("end loadPolygonCategory()")}
function showHideCategory(a,c,b){c.slideToggle();c.toggleClass("hidden");if("parking"==a)console.log("category == parking"),"hidden"==c.attr("class")?(console.log("obj == hidden, set map to null"),parkingLayer.setMap(null)):(console.log("obj != hidden, set map to show"),parkingLayer.setMap(map));else if("hidden"==c.attr("class"))for(var d in markerArray[b])markerArray[b][d].setVisible(!1);else for(d in markerArray[b])fitToMarkers(markerArray[b]),markerArray[b][d].setVisible(!0)}
function displayPoint(a){$("#message").hide();var c=google.maps.event.addListener(map,"moveend",function(){var b=map.fromLatLngToDivPixel(a.getPosition());$("#message").fadeIn().css({top:b.y,left:b.x});google.maps.event.removeListener(c)});map.panTo(a.getPosition());google.maps.event.trigger(a,"click")}function perform(a){return this[a]}function windowResize(){var a=$("#menu").width();$("#map_canvas").width();var c=$("body").width();$("#map_canvas").width(c-a)}
function fitToMarkers(a){var c=new google.maps.LatLngBounds,b;for(b in a){var d=a[b].getPosition();c.extend(d)}c.getNorthEast().equals(c.getSouthWest())&&(a=new google.maps.LatLng(c.getNorthEast().lat()+0.01,c.getNorthEast().lng()+0.01),b=new google.maps.LatLng(c.getNorthEast().lat()-0.01,c.getNorthEast().lng()-0.01),c.extend(a),c.extend(b));map.fitBounds(c)}
$(window).load(function(){initialize();windowResize();$(".marker_category_a").live("click",function(){category=$(this).attr("id");obj=$(this).siblings("div");catIndex=$(this).attr("name");populateCategories(category,obj,catIndex)})});window.onresize=function(){windowResize()};
